language: java

jdk:
  - oraclejdk11
  - oraclejdk9
  - openjdk11
  - openjdk10
  - openjdk9

matrix:
  include:
    - jdk: oraclejdk8
      addons:
        sonarcloud:
          organization: eyedeekay-github
          projectkey: eyedeekay_i2p.i2p
          login: RmKvY6GVA4A6B6cIXhnmoqKEBQnA7tc6G6RUP0gNTjAMttgaZa1H2j/Oaw3fQVka7GDnxzJnseeK8EPaLS1dDY/Ok0cm1uSuBS+S0ZNKEt+LJf9KRvPp4irwqDBciK6s65tI7wzMHu88MTi0d46rpqwXuZ/erppp/IgjAQVpQ9mykgwpLWNXRSirkVCIF1RUqAJMBvKAlficwUVSYQuoljb8A0zQa2kjLXbsiKuu6uSS8VKAXhN/FTgKJAvlGKi4z5qrzQjafc3TnHqDfRLmoNgHkzSTOhyi+5OLfbaFCcE1dM3PyU+7Vw1sWwyvRsznGC0BH3vwTxB/WRRlZ7C5uLoRB+HdV8Pcfo1fXUJ5UKtUKo4fBNP1H1q3wIpkVb/CuGOzIb2rKozT1Ohc6WdotD41WcbOYuUAMJZVUliGqJOAp085RxB9FBxAWZoQJxaQPrPxPvx6IRoDdxubXBj8MAZixO7wDwuHeoWvvtrTdA8bnUU9RiaLvx0/+7dPTF4Lls6SI6OVyho1rdY2gcRUc41ndOuP9Huyiv4xzuKwch+oqDmv5tLC0N2xBzMZfCmUCRbastUG+Vw+8gBzZKF5x19N2kyuoQPC5k0+YJBQ9a1Jy8AC+sNcmYWclVVbukADIDNnlIFj1eourPQCrGLl4/g8G8QEVXM31d9S5MAGa7o=
          token:
            secure: RmKvY6GVA4A6B6cIXhnmoqKEBQnA7tc6G6RUP0gNTjAMttgaZa1H2j/Oaw3fQVka7GDnxzJnseeK8EPaLS1dDY/Ok0cm1uSuBS+S0ZNKEt+LJf9KRvPp4irwqDBciK6s65tI7wzMHu88MTi0d46rpqwXuZ/erppp/IgjAQVpQ9mykgwpLWNXRSirkVCIF1RUqAJMBvKAlficwUVSYQuoljb8A0zQa2kjLXbsiKuu6uSS8VKAXhN/FTgKJAvlGKi4z5qrzQjafc3TnHqDfRLmoNgHkzSTOhyi+5OLfbaFCcE1dM3PyU+7Vw1sWwyvRsznGC0BH3vwTxB/WRRlZ7C5uLoRB+HdV8Pcfo1fXUJ5UKtUKo4fBNP1H1q3wIpkVb/CuGOzIb2rKozT1Ohc6WdotD41WcbOYuUAMJZVUliGqJOAp085RxB9FBxAWZoQJxaQPrPxPvx6IRoDdxubXBj8MAZixO7wDwuHeoWvvtrTdA8bnUU9RiaLvx0/+7dPTF4Lls6SI6OVyho1rdY2gcRUc41ndOuP9Huyiv4xzuKwch+oqDmv5tLC0N2xBzMZfCmUCRbastUG+Vw+8gBzZKF5x19N2kyuoQPC5k0+YJBQ9a1Jy8AC+sNcmYWclVVbukADIDNnlIFj1eourPQCrGLl4/g8G8QEVXM31d9S5MAGa7o=
      before_install:
        - export JAVA7_HOME=$(jdk_switcher home openjdk7)
        - sed -i "1iplugins {\n    id 'org.sonarqube' version '2.7'\n}\n" build.gradle
    - jdk: openjdk8
      before_install:
        - export JAVA7_HOME=$(jdk_switcher home openjdk7)
    - jdk: openjdk7
      sudo: required
      before_install: # Work around missing crypto in openjdk7
        - export JAVA7_HOME=$(jdk_switcher home openjdk7)
        - sudo wget "https://bouncycastle.org/download/bcprov-ext-jdk15on-158.jar" -O "${JAVA_HOME}/jre/lib/ext/bcprov-ext-jdk15on-158.jar"
        - sudo perl -pi.bak -e 's/^(security\.provider\.)([0-9]+)/$1.($2+1)/ge' /etc/java-7-openjdk/security/java.security
        - echo "security.provider.1=org.bouncycastle.jce.provider.BouncyCastleProvider" | sudo tee -a /etc/java-7-openjdk/security/java.security
      install:
        - export TARGET_JAVA_HOME=$JAVA_HOME
        - jdk_switcher use oraclejdk8
        - ./gradlew assemble

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
  - echo "# NOTE: This I2P config file must use UTF-8 encoding" > core/logger.config
  - echo "logger.minimumOnScreenLevel=CRIT" >> core/logger.config
  - echo "logger.record.net.i2p.util.LogSettingsTest=ERROR" >> core/logger.config
cache:
  directories:
    - $HOME/.sonar/cache/

script:
  - |
    if [ "$TRAVIS_JDK_VERSION" == "oraclejdk8" ]; then
      ./gradlew check codeCoverageReport
      ## Sonarcloud temporarily disabled
      #./gradlew sonarqube codeCoverageReport
    else
      ./gradlew check codeCoverageReport
    fi
    ant installer-linux

after_success:
  - bash <(curl -s https://codecov.io/bash)

#notifications:
#  irc:
#    channels:
#      - "chat.freenode.net#i2p-dev"
#    on_success: change
#    on_failure: always

